<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Matt Plastow">

<title>Matt Plastow - Portfolio - Building the predictive model</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Matt Plastow - Portfolio</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html">Home</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./analysis_summary.html" aria-current="page">Predicting NYC Home Prices</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./leaflet_maps_sfh_2021.html">Mapping NYC Home Prices</a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Building the predictive model</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_summary.html" class="sidebar-item-text sidebar-link">Summary</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_intro.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_wrangling1.html" class="sidebar-item-text sidebar-link">Wrangling the sales data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_wrangling2.html" class="sidebar-item-text sidebar-link">Wrangling the other data</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_eda.html" class="sidebar-item-text sidebar-link">Exploratory data analysis</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_model.html" class="sidebar-item-text sidebar-link active">Building the predictive model</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./analysis_outro.html" class="sidebar-item-text sidebar-link">Discussion and next steps</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#tidymodels" id="toc-tidymodels" class="nav-link active" data-scroll-target="#tidymodels">Tidymodels</a></li>
  <li><a href="#selecting-one-model-from-several" id="toc-selecting-one-model-from-several" class="nav-link" data-scroll-target="#selecting-one-model-from-several">Selecting one model from several</a>
  <ul class="collapse">
  <li><a href="#specifying-the-models" id="toc-specifying-the-models" class="nav-link" data-scroll-target="#specifying-the-models">Specifying the models</a></li>
  <li><a href="#writing-a-recipe-for-preprocessing" id="toc-writing-a-recipe-for-preprocessing" class="nav-link" data-scroll-target="#writing-a-recipe-for-preprocessing">Writing a recipe for preprocessing</a></li>
  <li><a href="#defining-a-cross-validation-scheme" id="toc-defining-a-cross-validation-scheme" class="nav-link" data-scroll-target="#defining-a-cross-validation-scheme">Defining a cross-validation scheme</a></li>
  </ul></li>
  <li><a href="#comparing-multiple-models" id="toc-comparing-multiple-models" class="nav-link" data-scroll-target="#comparing-multiple-models">Comparing multiple models</a></li>
  <li><a href="#tuning-the-selected-model" id="toc-tuning-the-selected-model" class="nav-link" data-scroll-target="#tuning-the-selected-model">Tuning the selected model</a></li>
  <li><a href="#tuning-results" id="toc-tuning-results" class="nav-link" data-scroll-target="#tuning-results">Tuning results</a></li>
  <li><a href="#testing-the-tuned-model" id="toc-testing-the-tuned-model" class="nav-link" data-scroll-target="#testing-the-tuned-model">Testing the tuned model</a>
  <ul class="collapse">
  <li><a href="#variable-importance" id="toc-variable-importance" class="nav-link" data-scroll-target="#variable-importance">Variable importance</a></li>
  <li><a href="#predictions-and-residuals" id="toc-predictions-and-residuals" class="nav-link" data-scroll-target="#predictions-and-residuals">Predictions and residuals</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Building the predictive model</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Matt Plastow </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<section id="tidymodels" class="level2">
<h2 class="anchored" data-anchor-id="tidymodels">Tidymodels</h2>
<p>We will use the tidymodels framework for building and tuning the model. Tidymodels uses similar principles to the tidyverse to provide standard interfaces across many different model types. It uses an integrated workflow for all parts of the modeling process, from data preprocessing to tuning models to fitting the final model.</p>
</section>
<section id="selecting-one-model-from-several" class="level2">
<h2 class="anchored" data-anchor-id="selecting-one-model-from-several">Selecting one model from several</h2>
<p>The nonlinear relationships uncovered in exploratory data analysis indicate that models that capture nonlinear effects will be more suitable for our data. Additionally, given that we have more than a handful of predictors, it is more efficient to use models with automatic feature selection, which will weight variables by relevance or importance during model training. This capability will avoid the need to manually specify predictors in the model recipe.</p>
<p>We will compare the performance of these four models in order to select one for tuning.</p>
<ul>
<li><p>Linear model: An ordinary least squares model, included to compare to the other models and not as a candidate.</p></li>
<li><p>MARS model: A regression model that captures nonlinear relationships using spline features.</p></li>
<li><p>Boosted trees with xgboost: A random forest that learns from the performance of previous trees.</p></li>
<li><p>Rules-based model with cubist: A model that uses ensembles of rules derived from “flattened” trees.</p></li>
</ul>
<section id="specifying-the-models" class="level3">
<h3 class="anchored" data-anchor-id="specifying-the-models">Specifying the models</h3>
<p>All the models are initially specified to use the default settings for their engines, rather than having settings manually specified or determined with tuning.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-4_507284124f5cec9102430d1b85f96021">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># LM model spec</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lm_spec <span class="ot">&lt;-</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">linear_reg</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"lm"</span>)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># MARS model spec</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>earth_spec <span class="ot">&lt;-</span> </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mars</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"earth"</span>)</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Boosted tree model spec</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>xgboost_spec <span class="ot">&lt;-</span> </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">boost_tree</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"regression"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"xgboost"</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Cubist model spec</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>cubist_spec <span class="ot">&lt;-</span> </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cubist_rules</span>() <span class="sc">|&gt;</span> </span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"Cubist"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="writing-a-recipe-for-preprocessing" class="level3">
<h3 class="anchored" data-anchor-id="writing-a-recipe-for-preprocessing">Writing a recipe for preprocessing</h3>
<p>In tidymodels, preprocessing the data is done by writing “recipes”. All models can use the same recipe, as none of them have mutually-exclusive requirements for preprocessing.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-5_a4d4731aedd05a0e628930e2274d6780">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>base_recipe <span class="ot">&lt;-</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Specify the basic recipe</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">recipe</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> sale_price <span class="sc">~</span> .,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sfh_prices_train</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Change variable roles to identifier, rather than predictors</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">update_role</span>(<span class="fu">c</span>(</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    sale_id,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    address,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    bbl,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    neighborhood,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    nta_code</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">new_role =</span> <span class="st">"identifier"</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the borough variable to a factor</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_string2factor</span>(<span class="fu">all_of</span>(<span class="st">"borough"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert sale dates into week-of-year</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_date</span>(</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">one_of</span>(<span class="st">"sale_date"</span>),</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">features =</span> <span class="st">"week"</span>,</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">keep_original_cols =</span> <span class="cn">FALSE</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Convert the historic district indicator into an explicit numeric</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_mutate</span>(</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">historic =</span> <span class="fu">as.numeric</span>(historic)</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Impute any missing values</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_impute_knn</span>(<span class="fu">all_numeric_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create dummy variables for the borough variable, using one-hot encoding</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_dummy</span>(<span class="fu">all_nominal_predictors</span>(), <span class="at">one_hot =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Zero-variance filter</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_zv</span>(<span class="fu">all_predictors</span>()) <span class="sc">|&gt;</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Correlation filter</span></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_corr</span>(</span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">all_predictors</span>(),</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">threshold =</span> <span class="fl">0.9</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Normalize (center and scale) all predictors</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">step_normalize</span>(<span class="fu">all_predictors</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="defining-a-cross-validation-scheme" class="level3">
<h3 class="anchored" data-anchor-id="defining-a-cross-validation-scheme">Defining a cross-validation scheme</h3>
<p>Overfitting to the training set can be mitigated by using a resampling scheme to repeatedly test models generated during the training process. Ten-fold cross-validation, used here, splits the data randomly into ten subsets and holds one in reserve to validate the model fitted on the other nine. Cross-validation is repeated 10 times, holding each subset in reserve once in turn. The performance statistics generated during each round of cross-validation are averaged to produce a final metric for evaluating the model.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-7_c83a1ec2c401f775e3861884fa98c0d4">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a resampling scheme using 10-fold cross-validation.</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">412412</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>sfh_prices_folds <span class="ot">&lt;-</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">vfold_cv</span>(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> sfh_prices_train,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">v =</span> <span class="dv">10</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">repeats =</span> <span class="dv">1</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">strata =</span> sale_price</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="comparing-multiple-models" class="level2">
<h2 class="anchored" data-anchor-id="comparing-multiple-models">Comparing multiple models</h2>
<p>All three nonlinear models substantially outperformed the linear model. The MARS model underperformed the others by a small margin, while the Cubist and boosted tree models were very close in both RMSE and R-squared.</p>
<p>The Cubist model will be selected for tuning, as it has a slight edge over the boosted tree model in consistency (i.e., smaller standard error), though either model would work here.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-9_f4b7ec2c3fcdf6d0c30b7537123be055">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 8 × 4
  model        .metric       mean    std_err
  &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt;
1 linear_reg   rmse    373563.    13664.    
2 linear_reg   rsq          0.709     0.0180
3 mars         rmse    308800.    14761.    
4 mars         rsq          0.799     0.0198
5 boost_tree   rmse    276004.    13874.    
6 boost_tree   rsq          0.840     0.0180
7 cubist_rules rmse    279250.    10639.    
8 cubist_rules rsq          0.839     0.0130</code></pre>
</div>
</div>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-10_5e0be210b02bc66d0010e03c2f0c3036">
<div class="cell-output-display">
<p><img src="analysis_model_files/figure-html/unnamed-chunk-10-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
<section id="tuning-the-selected-model" class="level2">
<h2 class="anchored" data-anchor-id="tuning-the-selected-model">Tuning the selected model</h2>
<p>The Cubist model will be trained with 10 sets of these two parameters:</p>
<ul>
<li><p>Number of committees: the number of iterations allowed for formulating and adjusting the rules</p></li>
<li><p>Number of neighbors: the number of nearby points used for adjusting the predictions produced by the model</p></li>
</ul>
<p>The parameter sets are generated using a random grid search method.</p>
</section>
<section id="tuning-results" class="level2">
<h2 class="anchored" data-anchor-id="tuning-results">Tuning results</h2>
<p>The tuning results show that all candidate parameter sets outperformed the untuned model, some by about as 15%.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-15_4baaf8a1537dcd5909736e3f1a80815b">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 5
   model        .metric    mean     n std_err
   &lt;chr&gt;        &lt;chr&gt;     &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;
 1 cubist_rules rmse    244874.    10   7784.
 2 cubist_rules rmse    244971.    10   6963.
 3 cubist_rules rmse    245265.    10   7546.
 4 cubist_rules rmse    245285.    10   7327.
 5 cubist_rules rmse    245903.    10   7666.
 6 cubist_rules rmse    249281.    10   6899.
 7 cubist_rules rmse    252045.    10   6317.
 8 cubist_rules rmse    253730.    10   9640.
 9 cubist_rules rmse    256380.    10   9190.
10 cubist_rules rmse    269865.    10   6236.</code></pre>
</div>
</div>
<p>We select a model with an algorithm that favors a less complex model (in this case, fewer committees), allowing a performance loss of up to than 2% compared the best-performing model. The principle here is that a less complex model has a better chance of generalizing to the test set.</p>
<p>The model selected by this process has the following parameters:</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-16_56beab568698f575e004f17722d452a8">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 8
  committees neighbors .metric .estimator    mean std_err   .best .loss
       &lt;int&gt;     &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;        &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;
1         15         8 rmse    standard   245265.   7546. 244874. 0.159</code></pre>
</div>
</div>
<p>Note that the selected Cubist model performs substantially better than the untuned model, and has only 0.76% performance loss compared to the best candidate model produced by tuning.</p>
<p>Here are the selected model’s performance metrics:</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-17_3246285503b433077bb9ce0deb924350">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 4
  model        .metric       mean    std_err
  &lt;chr&gt;        &lt;chr&gt;        &lt;dbl&gt;      &lt;dbl&gt;
1 cubist_rules rmse    245265.    7546.     
2 cubist_rules rsq          0.876    0.00892</code></pre>
</div>
</div>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-18_4d452b385ac7e07e6a8218c4322d3522">

</div>
</section>
<section id="testing-the-tuned-model" class="level2">
<h2 class="anchored" data-anchor-id="testing-the-tuned-model">Testing the tuned model</h2>
<p>The last step is to fit the selected model to the test set. The metrics for the test fit show that the model’s performance is comparable to the best model trained on the training set.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-24_b46b4f723c84da02584fa44f44334036">
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  .metric .estimator  .estimate .config             
  &lt;chr&gt;   &lt;chr&gt;           &lt;dbl&gt; &lt;chr&gt;               
1 rmse    standard   247730.    Preprocessor1_Model1
2 mae     standard   117576.    Preprocessor1_Model1
3 rsq     standard        0.869 Preprocessor1_Model1</code></pre>
</div>
</div>
<section id="variable-importance" class="level3">
<h3 class="anchored" data-anchor-id="variable-importance">Variable importance</h3>
<p>Based on the variable importance plot for the fitted model, location (both absolute and in relationship to city hall), building and lot area, are the most important variables. This finding makes intuitive sense, as location and size of homes are the most heavily-promoted details in real estate listings. Of all the measures of nearby amenities, distance to the nearest subway station is the most important.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-25_b160dbee7c5904267c8f579a7e8be355">
<div class="cell-output-display">
<p><img src="analysis_model_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-26_acf3aaa999c0347d05e56c84124ab33d">

</div>
</section>
<section id="predictions-and-residuals" class="level3">
<h3 class="anchored" data-anchor-id="predictions-and-residuals">Predictions and residuals</h3>
<p>The prediction-residual plot shows significant heteroskedacity. That is, the residuals tend to increase in magnitude as predicted prices increase, indicating a non-constant variance in the residuals. The distribution in the “mainstream” segment identified during visualization (under $1 million) is compact and symmetrical, while the spread in the “high-end” segment is much wider and has notable outliers. This heteroskedacity may indicate that there are latent “rules” for the high-end housing market that do not match the median market. If this is the case, further rounds of modeling could be able to account for these rules.</p>
<p>The heteroskedacity may also be the result of a sales dataset that is relatively sparse in the high end – the number of homes sold for more than $1 million was only 2054, and only 445 homes were sold for more than $2 million.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-28_eacea5af69d9ba1a2d51553796b14b95">
<div class="cell-output-display">
<p><img src="analysis_model_files/figure-html/unnamed-chunk-28-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-29_55ec27dd1c91fcb91a2cf5181575eee3">

</div>
<p>The graph on the left shows the ratio of residuals to predicted prices. The graph shows that the distribution is approximately symmetrical (in this graph, a ). The near-zero slope of the trend line indicates that the model’s error bias (toward either over- or under-prediction) is consistent across the price distribution.</p>
<p>The graph on the right is the absolute-value version of the graph on the left. The mean absolute residual (deviation from perfect prediction) is shown by the blue line, and the red trend line indicates that the model tends to produce predictions with larger relative errors as prices increase – perhaps, again, due to sparse data.</p>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-30_75d35a7badef78543e1a47155a2beab0">

</div>
<div class="cell" data-hash="analysis_model_cache/html/unnamed-chunk-31_be548b1c66b18948055eaced3995a374">
<div class="cell-output-display">
<p><img src="analysis_model_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="672"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
      <div class="nav-footer-center">Copyright 2022-23 Matt Plastow</div>
  </div>
</footer>



</body></html>